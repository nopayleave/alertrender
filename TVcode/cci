//@version=6
indicator(title="Commodity Channel Index", shorttitle="CCI", format=format.price, precision=2)
length = input.int(20, minval=1)
src = input(hlc3, title="Source")
ma = ta.sma(src, length)
cci = (src - ma) / (0.015 * ta.dev(src, length))

// Direction color inputs
colorUp = input.color(#22c55e, title="CCI Up Color", group="Color Settings", tooltip="Color when CCI is rising")
colorDown = input.color(#F23645, title="CCI Down Color", group="Color Settings", tooltip="Color when CCI is falling")
colorSpecial = input.color(color.white, title="Special Color", group="Color Settings", tooltip="Color when CCI > 100 and down, or CCI < -100 and up")

// Determine direction
cciIsUp = cci >= cci[1]
cciIsDown = cci < cci[1]

// Special conditions
cciOver100Down = cci > 100 and cciIsDown
cciBelow0Up = cci < 0 and cciIsUp
cciBetween0AndNeg100Up = cci >= -100 and cci < 0 and cciIsUp
cciBelowNeg100Up = cci < -100 and cciIsUp

// Apply color logic
cciColor = cciOver100Down or cciBelowNeg100Up ? colorSpecial : (cciBetween0AndNeg100Up ? colorUp : (cciIsUp ? colorUp : colorDown))
hline(40, "Level 40", color=color.yellow, linestyle=hline.style_solid, linewidth=1, editable=true)
hline(-40, "Level -40", color=color.yellow, linestyle=hline.style_solid, linewidth=1, editable=true)
plot(cci, "CCI", color=cciColor, linewidth = 4)
band1 = hline(100, "Upper Band", color=#787B86, linestyle=hline.style_dashed)
midBand = hline(0, "Middle Band", color=color.new(color.yellow, 50), linewidth=2)
band0 = hline(-100, "Lower Band", color=#787B86, linestyle=hline.style_dashed)
// Background fills: green for 0-100, red for 0 to -100 (25% opacity = 75% transparency)
fill(band1, midBand, color=color.new(#22c55e, 75), title="Green Background (0-100)")
fill(midBand, band0, color=color.new(#ef4444, 75), title="Red Background (0 to -100)")

// Smoothing MA inputs
GRP = "Smoothing"
TT_BB = "Only applies when 'SMA + Bollinger Bands' is selected. Determines the distance between the SMA and the bands."
maTypeInput = input.string("SMA", "Type", options = ["None", "SMA", "SMA + Bollinger Bands", "EMA", "SMMA (RMA)", "WMA", "VWMA"], group = GRP, display = display.data_window)
var isBB = maTypeInput == "SMA + Bollinger Bands"
maLengthInput = input.int(14, "Length", group = GRP, display = display.data_window, active = maTypeInput != "None")
bbMultInput = input.float(2.0, "BB StdDev", minval = 0.001, maxval = 50, step = 0.5, tooltip = TT_BB, group = GRP, display = display.data_window, active = isBB)
var enableMA = maTypeInput != "None"

// Smoothing MA Calculation
ma(source, length, MAtype) =>
	switch MAtype
		"SMA"                   => ta.sma(source, length)
		"SMA + Bollinger Bands" => ta.sma(source, length)
		"EMA"                   => ta.ema(source, length)
		"SMMA (RMA)"            => ta.rma(source, length)
		"WMA"                   => ta.wma(source, length)
		"VWMA"                  => ta.vwma(source, length)

// Smoothing MA plots
smoothingMA = enableMA ? ma(cci, maLengthInput, maTypeInput) : na
smoothingStDev = isBB ? ta.stdev(cci, maLengthInput) * bbMultInput : na

// Apply same direction color logic to smoothing MA
smoothingMAIsUp = smoothingMA >= smoothingMA[1]
smoothingMAIsDown = smoothingMA < smoothingMA[1]
smoothingMAOver100Down = smoothingMA > 100 and smoothingMAIsDown
smoothingMABelow0Up = smoothingMA < 0 and smoothingMAIsUp
smoothingMABetween0AndNeg100Up = smoothingMA >= -100 and smoothingMA < 0 and smoothingMAIsUp
smoothingMABelowNeg100Up = smoothingMA < -100 and smoothingMAIsUp
smoothingMAColor = smoothingMAOver100Down or smoothingMABelowNeg100Up ? colorSpecial : (smoothingMABetween0AndNeg100Up ? colorUp : (smoothingMAIsUp ? colorUp : colorDown))

plot(smoothingMA, "CCI-based MA", color=smoothingMAColor, linewidth = 4, display = enableMA ? display.all : display.none, editable = enableMA)
bbUpperBand = plot(smoothingMA + smoothingStDev, title = "Upper Bollinger Band", color=color.green, display = isBB ? display.all : display.none, editable = isBB)
bbLowerBand = plot(smoothingMA - smoothingStDev, title = "Lower Bollinger Band", color=color.green, display = isBB ? display.all : display.none, editable = isBB)
fill(bbUpperBand, bbLowerBand, color= isBB ? color.new(color.green, 90) : na, title="Bollinger Bands Background Fill", display = isBB ? display.all : display.none, editable = isBB)

// Webhook alert settings
enableWebhook = input.bool(true, title="Enable Webhook Alerts", group="Webhook Alerts")
webhookFrequency = input.string("Once Per Bar Close", title="Alert Frequency", options=["Once Per Bar Close", "Once Per Bar", "All"], group="Webhook Alerts")

// Determine alert frequency
alertFreq = webhookFrequency == "Once Per Bar Close" ? alert.freq_once_per_bar_close : 
           webhookFrequency == "Once Per Bar" ? alert.freq_once_per_bar : 
           alert.freq_all

// Detect crossovers
// CCI crossing MA
cciCrossMAUp = enableMA and ta.crossover(cci, smoothingMA)
cciCrossMADown = enableMA and ta.crossunder(cci, smoothingMA)

// MA crossing 100/-100
maCross100Up = enableMA and ta.crossover(smoothingMA, 100)
maCross100Down = enableMA and ta.crossunder(smoothingMA, 100)
maCrossNeg100Up = enableMA and ta.crossover(smoothingMA, -100)
maCrossNeg100Down = enableMA and ta.crossunder(smoothingMA, -100)

// CCI crossing 100/-100
cciCross100Up = ta.crossover(cci, 100)
cciCross100Down = ta.crossunder(cci, 100)
cciCrossNeg100Up = ta.crossover(cci, -100)
cciCrossNeg100Down = ta.crossunder(cci, -100)

// Determine CCI direction
cciDirection = cciIsUp ? "up" : cciIsDown ? "down" : "flat"

// Webhook alerts for crossovers
if enableWebhook and barstate.isconfirmed
    // CCI crossing MA
    if cciCrossMAUp
        jsonMsg = '{' +
          '"symbol": "' + syminfo.ticker + '",' +
          '"timeframe": "' + timeframe.period + '",' +
          '"time": "' + str.tostring(time) + '",' +
          '"price": ' + str.tostring(close) + ',' +
          '"cciCrossover": "CCI_MA",' +
          '"cciDirection": "' + cciDirection + '",' +
          '"cciValue": ' + str.tostring(cci, "#.##") + ',' +
          '"cciMAValue": ' + str.tostring(smoothingMA, "#.##") + '}'
        alert(jsonMsg, freq = alertFreq)
    
    if cciCrossMADown
        jsonMsg = '{' +
          '"symbol": "' + syminfo.ticker + '",' +
          '"timeframe": "' + timeframe.period + '",' +
          '"time": "' + str.tostring(time) + '",' +
          '"price": ' + str.tostring(close) + ',' +
          '"cciCrossover": "CCI_MA",' +
          '"cciDirection": "' + cciDirection + '",' +
          '"cciValue": ' + str.tostring(cci, "#.##") + ',' +
          '"cciMAValue": ' + str.tostring(smoothingMA, "#.##") + '}'
        alert(jsonMsg, freq = alertFreq)
    
    // MA crossing 100
    if maCross100Up
        jsonMsg = '{' +
          '"symbol": "' + syminfo.ticker + '",' +
          '"timeframe": "' + timeframe.period + '",' +
          '"time": "' + str.tostring(time) + '",' +
          '"price": ' + str.tostring(close) + ',' +
          '"cciCrossover": "MA_100",' +
          '"cciDirection": "' + cciDirection + '",' +
          '"cciValue": ' + str.tostring(cci, "#.##") + ',' +
          '"cciMAValue": ' + str.tostring(smoothingMA, "#.##") + '}'
        alert(jsonMsg, freq = alertFreq)
    
    if maCross100Down
        jsonMsg = '{' +
          '"symbol": "' + syminfo.ticker + '",' +
          '"timeframe": "' + timeframe.period + '",' +
          '"time": "' + str.tostring(time) + '",' +
          '"price": ' + str.tostring(close) + ',' +
          '"cciCrossover": "MA_100",' +
          '"cciDirection": "' + cciDirection + '",' +
          '"cciValue": ' + str.tostring(cci, "#.##") + ',' +
          '"cciMAValue": ' + str.tostring(smoothingMA, "#.##") + '}'
        alert(jsonMsg, freq = alertFreq)
    
    // MA crossing -100
    if maCrossNeg100Up
        jsonMsg = '{' +
          '"symbol": "' + syminfo.ticker + '",' +
          '"timeframe": "' + timeframe.period + '",' +
          '"time": "' + str.tostring(time) + '",' +
          '"price": ' + str.tostring(close) + ',' +
          '"cciCrossover": "MA_NEG100",' +
          '"cciDirection": "' + cciDirection + '",' +
          '"cciValue": ' + str.tostring(cci, "#.##") + ',' +
          '"cciMAValue": ' + str.tostring(smoothingMA, "#.##") + '}'
        alert(jsonMsg, freq = alertFreq)
    
    if maCrossNeg100Down
        jsonMsg = '{' +
          '"symbol": "' + syminfo.ticker + '",' +
          '"timeframe": "' + timeframe.period + '",' +
          '"time": "' + str.tostring(time) + '",' +
          '"price": ' + str.tostring(close) + ',' +
          '"cciCrossover": "MA_NEG100",' +
          '"cciDirection": "' + cciDirection + '",' +
          '"cciValue": ' + str.tostring(cci, "#.##") + ',' +
          '"cciMAValue": ' + str.tostring(smoothingMA, "#.##") + '}'
        alert(jsonMsg, freq = alertFreq)
    
    // CCI crossing 100
    if cciCross100Up
        jsonMsg = '{' +
          '"symbol": "' + syminfo.ticker + '",' +
          '"timeframe": "' + timeframe.period + '",' +
          '"time": "' + str.tostring(time) + '",' +
          '"price": ' + str.tostring(close) + ',' +
          '"cciCrossover": "CCI_100",' +
          '"cciDirection": "' + cciDirection + '",' +
          '"cciValue": ' + str.tostring(cci, "#.##") + ',' +
          '"cciMAValue": ' + str.tostring(smoothingMA, "#.##") + '}'
        alert(jsonMsg, freq = alertFreq)
    
    if cciCross100Down
        jsonMsg = '{' +
          '"symbol": "' + syminfo.ticker + '",' +
          '"timeframe": "' + timeframe.period + '",' +
          '"time": "' + str.tostring(time) + '",' +
          '"price": ' + str.tostring(close) + ',' +
          '"cciCrossover": "CCI_100",' +
          '"cciDirection": "' + cciDirection + '",' +
          '"cciValue": ' + str.tostring(cci, "#.##") + ',' +
          '"cciMAValue": ' + str.tostring(smoothingMA, "#.##") + '}'
        alert(jsonMsg, freq = alertFreq)
    
    // CCI crossing -100
    if cciCrossNeg100Up
        jsonMsg = '{' +
          '"symbol": "' + syminfo.ticker + '",' +
          '"timeframe": "' + timeframe.period + '",' +
          '"time": "' + str.tostring(time) + '",' +
          '"price": ' + str.tostring(close) + ',' +
          '"cciCrossover": "CCI_NEG100",' +
          '"cciDirection": "' + cciDirection + '",' +
          '"cciValue": ' + str.tostring(cci, "#.##") + ',' +
          '"cciMAValue": ' + str.tostring(smoothingMA, "#.##") + '}'
        alert(jsonMsg, freq = alertFreq)
    
    if cciCrossNeg100Down
        jsonMsg = '{' +
          '"symbol": "' + syminfo.ticker + '",' +
          '"timeframe": "' + timeframe.period + '",' +
          '"time": "' + str.tostring(time) + '",' +
          '"price": ' + str.tostring(close) + ',' +
          '"cciCrossover": "CCI_NEG100",' +
          '"cciDirection": "' + cciDirection + '",' +
          '"cciValue": ' + str.tostring(cci, "#.##") + ',' +
          '"cciMAValue": ' + str.tostring(smoothingMA, "#.##") + '}'
        alert(jsonMsg, freq = alertFreq)
