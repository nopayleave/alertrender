//@version=6
indicator(title="Stochastic", shorttitle="Stoch Logic", format=format.price, precision=2)
periodK = input.int(25, title="%K Length", minval=1)
smoothK = input.int(7, title="%K Smoothing", minval=1)
periodD = input.int(6, title="%D Smoothing", minval=1)

k = ta.sma(ta.stoch(close, high, low, periodK), smoothK)
d = ta.sma(k, periodD)

// Color Settings for K
colorKUp = input.color(#00FF00, title="K Up Color", group="K Settings")
colorKDown = input.color(#0044ff, title="K Down Color", group="K Settings")
colorKTrendUp = input.color(#00FF00, title="K Trend Up Color (>80)", group="K Settings")
colorKTrendDown = input.color(#ff0000, title="K Trend Down Color (<20)", group="K Settings")
colorKBelow20TrendUp = input.color(#ffff00, title="K Below 20 Trend Up Color", group="K Settings")
colorKAbove80TrendDown = input.color(#ff8800, title="K Above 80 Trend Down Color", group="K Settings")

// Color Settings for D
colorDUp = input.color(#00FF00, title="D Up Color", group="D Settings")
colorDDown = input.color(#0044ff, title="D Down Color", group="D Settings")
colorDTrendUp = input.color(#00FF00, title="D Trend Up Color (>80)", group="D Settings")
colorDTrendDown = input.color(#ff0000, title="D Trend Down Color (<20)", group="D Settings")
colorDBelow20TrendUp = input.color(#ffff00, title="D Below 20 Trend Up Color", group="D Settings")
colorDAbove80TrendDown = input.color(#ff8800, title="D Above 80 Trend Down Color", group="D Settings")

// Logic for K
kIsUp = k >= k[1]
kBaseColor = kIsUp ? colorKUp : colorKDown
kLineColor = (k < 20 and kIsUp) ? colorKBelow20TrendUp : (k > 80 and not kIsUp) ? colorKAbove80TrendDown : k > 80 ? colorKTrendUp : k < 20 ? colorKTrendDown : kBaseColor

// Logic for D
dIsUp = d >= d[1]
dBaseColor = dIsUp ? colorDUp : colorDDown
dLineColor = (d < 20 and dIsUp) ? colorDBelow20TrendUp : (d > 80 and not dIsUp) ? colorDAbove80TrendDown : d > 80 ? colorDTrendUp : d < 20 ? colorDTrendDown : dBaseColor

// ===== DAY OPEN TREND (9:30) =====
showDayOpenLabel = input.bool(true, title="Show Day Open Trend Label", group="Day Open Trend")
sessionTZ = input.string("America/New_York", title="Session Timezone", group="Day Open Trend")

inSession = not na(time(timeframe.period, "0930-1600", sessionTZ))
var int barsSince930 = 0
if inSession
    barsSince930 := inSession[1] ? barsSince930 + 1 : 1
else
    barsSince930 := 0

var float firstCandleK = na
if barsSince930 == 1
    firstCandleK := k
else if barsSince930 == 0
    firstCandleK := na

// W↑(weak up) / S↓(strong down) / S↑(strong up) / W↓(weak down)
// Short focus (red): W↑, S↓ | Long focus (green): S↑, W↓
dayOpenKUp = k > firstCandleK
dayOpenKDown = k < firstCandleK
below40 = k < 40
above40 = k >= 40

dayOpenLabelStr = "none"
dayOpenLabelColor = color.gray
if barsSince930 == 2 and not na(firstCandleK) and (dayOpenKUp or dayOpenKDown)
    if below40 and dayOpenKUp
        dayOpenLabelStr := "W↑"
        dayOpenLabelColor := color.red      // short focus
    else if below40 and dayOpenKDown
        dayOpenLabelStr := "S↓"
        dayOpenLabelColor := color.red      // short focus
    else if above40 and dayOpenKUp
        dayOpenLabelStr := "S↑"
        dayOpenLabelColor := color.green    // long focus
    else if above40 and dayOpenKDown
        dayOpenLabelStr := "W↓"
        dayOpenLabelColor := color.green    // long focus

if showDayOpenLabel and inSession and dayOpenLabelStr != "none"
    label.new(bar_index, math.max(k, 85), dayOpenLabelStr, style=label.style_label_down, color=dayOpenLabelColor, textcolor=color.white, size=size.normal)

// Persist day focus for the session (long = S↑/W↓, short = W↑/S↓)
var string dayFocus = "none"
var float shortEntryK = na
var bool switchedToLong = false
var bool switchedToShort = false
var bool slShown = false
var bool ssShown = false
if barsSince930 == 1
    dayFocus := "none"
    shortEntryK := na
    switchedToLong := false
    switchedToShort := false
    slShown := false
    ssShown := false
else if barsSince930 == 2 and dayOpenLabelStr != "none"
    dayFocus := (dayOpenLabelStr == "S↑" or dayOpenLabelStr == "W↓") ? "long" : "short"

// ===== HL/LH DETECTION (based on K value at crossover/crossunder points) =====
showHL = input.bool(true, title="Show HL/LH Labels", group="HL/LH Settings")

kCrossOver = ta.crossover(k, d)
kCrossUnder = ta.crossunder(k, d)
onCross = kCrossOver or kCrossUnder

// Track K value at last crossover and crossunder
var float lastCrossOverK = na
var float prevCrossOverK = na
var float lastCrossUnderK = na
var float prevCrossUnderK = na

if kCrossOver
    prevCrossOverK := lastCrossOverK
    lastCrossOverK := k
if kCrossUnder
    prevCrossUnderK := lastCrossUnderK
    lastCrossUnderK := k

// HL/LL: crossover points = troughs in K. Compare current crossover K to previous.
// Higher Low = current crossover K > previous crossover K
int lowStructure = na
if kCrossOver and not na(prevCrossOverK)
    lowStructure := k > prevCrossOverK ? 1 : -1  // 1=HL, -1=LL

// HH/LH: crossunder points = peaks in K. Compare current crossunder K to previous.
// Lower High = current crossunder K < previous crossunder K
int highStructure = na
if kCrossUnder and not na(prevCrossUnderK)
    highStructure := k > prevCrossUnderK ? 1 : -1  // 1=HH, -1=LH

// String labels for alert
highStructureStr = highStructure == 1 ? "HH" : highStructure == -1 ? "LH" : "none"
lowStructureStr = lowStructure == 1 ? "HL" : lowStructure == -1 ? "LL" : "none"

// Plot HL/LH markers on crossover/crossunder bars (regular session only)
plotshape(showHL and inSession and kCrossUnder and highStructure == 1, title="Higher High", style=shape.triangledown, location=location.top, color=color.new(#00ff00, 0), size=size.small)
plotshape(showHL and inSession and kCrossUnder and highStructure == -1, title="Lower High", style=shape.triangledown, location=location.top, color=color.new(#ff0000, 0), size=size.small)
plotshape(showHL and inSession and kCrossOver and lowStructure == 1, title="Higher Low", style=shape.triangleup, location=location.bottom, color=color.new(#00ff00, 0), size=size.small)
plotshape(showHL and inSession and kCrossOver and lowStructure == -1, title="Lower Low", style=shape.triangleup, location=location.bottom, color=color.new(#ff0000, 0), size=size.small)

// ===== DIRECTION TRACKING =====
var float prevK = na
var float prevD = na
kDirection = na(prevK) ? "flat" : k > prevK ? "up" : k < prevK ? "down" : "flat"
dDirection = na(prevD) ? "flat" : d > prevD ? "up" : d < prevD ? "down" : "flat"
prevK := k
prevD := d

// ===== CROSSING DETECTION =====
kCross = kCrossOver ? "cross_over" : kCrossUnder ? "cross_under" : "none"

// Crossing Display Settings
showCrossOver = input.bool(true, title="Show K Cross Over D", group="Crossing Settings")
showCrossUnder = input.bool(true, title="Show K Cross Under D", group="Crossing Settings")
colorCrossOver = input.color(color.new(#00ff00, 0), title="Cross Over Color", group="Crossing Settings")
colorCrossUnder = input.color(color.new(#ff0000, 0), title="Cross Under Color", group="Crossing Settings")
int crossingSize = input.int(4, minval=1, maxval=5, title="Crossing Marker Size", group="Crossing Settings")
float crossingOffset = input.float(5.0, title="Crossing Marker Offset", group="Crossing Settings", step=1.0)

// Long day SS: LH below 50 OR K below 30 | Short day SL: HL above 50 OR K above 70
// Short day SS (when switchedToLong): LH below 50 OR K below 30
// SL and SS each trigger once per cycle; the other resets so they can alternate
// After SL → ssShown=false allows SS | After SS → slShown=false allows SL
kCrossAbove70 = ta.crossover(k, 70)
kCrossBelow30 = ta.crossunder(k, 30)
longDaySS = inSession and dayFocus == "long" and not ssShown and ((kCrossUnder and highStructure == -1 and k < 50) or kCrossBelow30)
shortDaySL = inSession and dayFocus == "short" and not slShown and ((kCrossOver and lowStructure == 1 and k > 50) or kCrossAbove70)
shortDaySS = inSession and dayFocus == "short" and switchedToLong and not ssShown and ((kCrossUnder and highStructure == -1 and k < 50) or kCrossBelow30)
if longDaySS
    switchedToShort := true
    ssShown := true
else if shortDaySL
    switchedToLong := true
    slShown := true
    ssShown := false
else if shortDaySS
    switchedToLong := false
    slShown := false
    ssShown := true

// Long focus: crossover=Buy, crossunder=Close | After SS: Sell/Close
// Short focus: crossunder=Sell, crossover=Close | After SL: Buy/Close | After SS: back to short
dayFocusSignal = "none"
if longDaySS
    dayFocusSignal := "SS"
else if shortDaySL
    dayFocusSignal := "SL"
else if shortDaySS
    dayFocusSignal := "SS"
else if inSession and dayFocus == "long"
    if switchedToShort
        dayFocusSignal := kCrossUnder ? "Sell" : kCrossOver ? "Close" : "none"
    else
        dayFocusSignal := kCrossOver ? "Buy" : kCrossUnder ? "Close" : "none"
else if inSession and dayFocus == "short"
    if switchedToLong
        dayFocusSignal := kCrossOver ? "Buy" : kCrossUnder ? "Close" : "none"
    else
        if kCrossUnder
            dayFocusSignal := "Sell"
            shortEntryK := k
        else if kCrossOver
            if not na(shortEntryK) and shortEntryK < 20
                dayFocusSignal := lowStructure == 1 ? "Close" : "none"  // close only on Higher Low
            else
                dayFocusSignal := "Close"
            if dayFocusSignal == "Close"
                shortEntryK := na
        else
            dayFocusSignal := "none"

showDayFocusSignal = input.bool(true, title="Show Buy/Sell/Close Labels", group="Day Open Trend")
showSL = input.bool(true, title="Show SL (Switch Long) Label", group="Day Open Trend")
showSS = input.bool(true, title="Show SS (Switch Short) Label", group="Day Open Trend")
if showDayFocusSignal and inSession and dayFocusSignal != "none"
    labelColor = dayFocusSignal == "Buy" ? color.green : dayFocusSignal == "Sell" ? color.red : dayFocusSignal == "SL" ? color.white : dayFocusSignal == "SS" ? color.white : color.gray
    labelTextColor = dayFocusSignal == "SL" ? color.green : dayFocusSignal == "SS" ? color.red : color.white
    labelY = (dayFocusSignal == "SL" or dayFocusSignal == "SS") ? (dayFocusSignal == "SL" ? math.min(k + 3, 95) : math.max(k - 3, 5)) : (dayFocusSignal == "Close" ? math.min(k, 15) : (dayFocusSignal == "Buy" ? k + crossingOffset : k - crossingOffset))
    showThisLabel = (dayFocusSignal == "SL" and showSL) or (dayFocusSignal == "SS" and showSS) or (dayFocusSignal != "SL" and dayFocusSignal != "SS")
    if showThisLabel
        label.new(bar_index, labelY, dayFocusSignal, style=label.style_label_down, color=labelColor, textcolor=labelTextColor, size=(dayFocusSignal == "SL" or dayFocusSignal == "SS") ? size.normal : size.small)

plot(k, title="%K", color=kLineColor, linewidth=2)
plot(d, title="%D", color=dLineColor, linewidth=2)

// Plot crossing markers (regular session only)
float crossOverPlot = na
if showCrossOver and inSession and kCrossOver
    crossOverPlot := k + crossingOffset

float crossUnderPlot = na
if showCrossUnder and inSession and kCrossUnder
    crossUnderPlot := k - crossingOffset

plot(crossOverPlot, title="K Cross Over D", color=colorCrossOver, linewidth=crossingSize, style=plot.style_circles)
plot(crossUnderPlot, title="K Cross Under D", color=colorCrossUnder, linewidth=crossingSize, style=plot.style_circles)
h0 = hline(80, "Upper Band", color=#787B86)
hline(50, "Middle Band", color=color.new(#e5ff00, 0))
hline(60, "Middle top Band", color=color.new(#e5ff00, 0), linestyle=hline.style_solid)
hline(40, "Middle base Band", color=color.new(#e5ff00, 0), linestyle=hline.style_solid)
hline(90, "Top top Band", color=color.new(#ffffff, 0))
hline(10, "Base Band", color=color.new(#ffffff, 0))
h1 = hline(20, "Lower Band", color=#787B86)
fill(h0, h1, color=color.rgb(33, 150, 243, 90), title="Background")

// ===== WEBHOOK ALERT =====
if barstate.isconfirmed
    alertStr = "{"
    alertStr += "\"symbol\":\"" + syminfo.ticker + "\","
    alertStr += "\"timeframe\":\"" + timeframe.period + "\","
    alertStr += "\"time\":\"" + str.tostring(time) + "\","
    alertStr += "\"price\":\"" + str.tostring(close) + "\","
    alertStr += "\"k\":\"" + str.tostring(k) + "\","
    alertStr += "\"d\":\"" + str.tostring(d) + "\","
    alertStr += "\"kDirection\":\"" + kDirection + "\","
    alertStr += "\"dDirection\":\"" + dDirection + "\","
    alertStr += "\"kCross\":\"" + kCross + "\","
    alertStr += "\"highStructure\":\"" + highStructureStr + "\","
    alertStr += "\"lowStructure\":\"" + lowStructureStr + "\","
    alertStr += "\"dayOpenTrend\":\"" + dayOpenLabelStr + "\","
    alertStr += "\"dayFocusSignal\":\"" + dayFocusSignal + "\""
    alertStr += "}"
    alert(alertStr, alert.freq_once_per_bar_close)