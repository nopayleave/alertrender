//@version=6
indicator(title="Stochastic", shorttitle="Stoch", format=format.price, precision=2)

// Timeframe: leave empty for chart timeframe
stochTimeframe = input.timeframe("", title="Timeframe", group="Timeframe", tooltip="Leave empty to use chart timeframe")

periodK = input.int(25, title="%K Length", minval=1)
smoothK = input.int(7, title="%K Smoothing", minval=1)
periodD = input.int(6, title="%D Smoothing", minval=1)

// Optional extra smoothing of K and D lines
smoothLines = input.bool(false, title="Smooth Lines", group="Smoothing")
smoothLen = input.int(3, minval=1, title="Smoothing Length", group="Smoothing")
smoothOffsetLeft = input.int(-1, title="Offset Left (bars)", group="Smoothing", minval=-5, maxval=0, tooltip="Shift plot slightly left when smoothing is on")

// Stochastic calculation (used in security when timeframe set)
f_stoch() =>
    k_ = ta.sma(ta.stoch(close, high, low, periodK), smoothK)
    d_ = ta.sma(k_, periodD)
    [k_, d_]

[k_chart, d_chart] = f_stoch()
[k_tf, d_tf] = request.security(syminfo.tickerid, stochTimeframe, f_stoch(), lookahead=barmerge.lookahead_off)

k_raw = stochTimeframe == "" ? k_chart : k_tf
d_raw = stochTimeframe == "" ? d_chart : d_tf
k = smoothLines ? ta.sma(k_raw, smoothLen) : k_raw
d = smoothLines ? ta.sma(d_raw, smoothLen) : d_raw

// Color Settings for K
colorKUp = input.color(#00FF00, title="K Up Color", group="K Settings")
colorKDown = input.color(#0044ff, title="K Down Color", group="K Settings")
colorKTrendUp = input.color(#00FF00, title="K Trend Up Color (>80)", group="K Settings")
colorKTrendDown = input.color(#ff0000, title="K Trend Down Color (<20)", group="K Settings")
colorKBelow20TrendUp = input.color(#ffff00, title="K Below 20 Trend Up Color", group="K Settings")
colorKAbove80TrendDown = input.color(#ff8800, title="K Above 80 Trend Down Color", group="K Settings")

// Color Settings for D
colorDUp = input.color(#00FF00, title="D Up Color", group="D Settings")
colorDDown = input.color(#0044ff, title="D Down Color", group="D Settings")
colorDTrendUp = input.color(#00FF00, title="D Trend Up Color (>80)", group="D Settings")
colorDTrendDown = input.color(#ff0000, title="D Trend Down Color (<20)", group="D Settings")
colorDBelow20TrendUp = input.color(#ffff00, title="D Below 20 Trend Up Color", group="D Settings")
colorDAbove80TrendDown = input.color(#ff8800, title="D Above 80 Trend Down Color", group="D Settings")

// Logic for K
kIsUp = k >= k[1]
kBaseColor = kIsUp ? colorKUp : colorKDown
kLineColor = (k < 20 and kIsUp) ? colorKBelow20TrendUp : (k > 80 and not kIsUp) ? colorKAbove80TrendDown : k > 80 ? colorKTrendUp : k < 20 ? colorKTrendDown : kBaseColor

// Logic for D
dIsUp = d >= d[1]
dBaseColor = dIsUp ? colorDUp : colorDDown
dLineColor = (d < 20 and dIsUp) ? colorDBelow20TrendUp : (d > 80 and not dIsUp) ? colorDAbove80TrendDown : d > 80 ? colorDTrendUp : d < 20 ? colorDTrendDown : dBaseColor

// ===== DIRECTION TRACKING =====
var float prevK = na
var float prevD = na
kDirection = na(prevK) ? "flat" : k > prevK ? "up" : k < prevK ? "down" : "flat"
dDirection = na(prevD) ? "flat" : d > prevD ? "up" : d < prevD ? "down" : "flat"
prevK := k
prevD := d

// ===== CROSSING DETECTION =====
kCrossOver = ta.crossover(k, d)
kCrossUnder = ta.crossunder(k, d)
kCross = kCrossOver ? "cross_over" : kCrossUnder ? "cross_under" : "none"

// ===== HL/LH: crossover compares with previous crossover value; crossunder with previous crossunder value =====
// Crossover: current crossover K vs last crossover K → HL when current > previous (higher crossover)
// Crossunder: current crossunder K vs last crossunder K → LH when current < previous (lower crossunder)
var float lastCrossOverK = na
var float lastCrossUnderK = na
string d2Pattern = ""
float d2PatternValue = na
if kCrossOver
    d2Pattern := na(lastCrossOverK) ? "" : k > lastCrossOverK ? "Higher Low" : ""
    d2PatternValue := k
    lastCrossOverK := k
else if kCrossUnder
    d2Pattern := na(lastCrossUnderK) ? "" : k < lastCrossUnderK ? "Lower High" : ""
    d2PatternValue := k
    lastCrossUnderK := k
else
    d2Pattern := ""
    d2PatternValue := na

// Crossing Display Settings
showCrossOver = input.bool(true, title="Show K Cross Over D", group="Crossing Settings")
showCrossUnder = input.bool(true, title="Show K Cross Under D", group="Crossing Settings")
colorCrossOver = input.color(color.new(#00ff00, 0), title="Cross Over Color", group="Crossing Settings")
colorCrossUnder = input.color(color.new(#ff0000, 0), title="Cross Under Color", group="Crossing Settings")
int crossingSize = input.int(4, minval=1, maxval=5, title="Crossing Marker Size", group="Crossing Settings")
float crossingOffset = input.float(5.0, title="Crossing Marker Offset", group="Crossing Settings", step=1.0)

plot(k, title="%K", color=kLineColor, linewidth=2, offset=smoothLines ? smoothOffsetLeft : 0)
plot(d, title="%D", color=dLineColor, linewidth=2, offset=smoothLines ? smoothOffsetLeft : 0)

// Plot crossing markers
float crossOverPlot = na
if showCrossOver and kCrossOver
    crossOverPlot := k + crossingOffset

float crossUnderPlot = na
if showCrossUnder and kCrossUnder
    crossUnderPlot := k - crossingOffset

plot(crossOverPlot, title="K Cross Over D", color=colorCrossOver, linewidth=crossingSize, style=plot.style_circles, offset=smoothLines ? smoothOffsetLeft : 0)
plot(crossUnderPlot, title="K Cross Under D", color=colorCrossUnder, linewidth=crossingSize, style=plot.style_circles, offset=smoothLines ? smoothOffsetLeft : 0)

// HL/LH label at crossover/crossunder (one label per cross)
showHLLH = input.bool(true, title="Show HL/LH Label", group="Crossing Settings")
labelColorHL = color.new(#00ff00, 0)
labelColorLH = color.new(#ff6600, 0)
if showHLLH and (kCrossOver or kCrossUnder) and d2Pattern != ""
    shortLabel = d2Pattern == "Higher Low" ? "HL" : "LH"
    labelStyle = d2Pattern == "Higher Low" ? label.style_label_down : label.style_label_up
    label.new(bar_index, k + (kCrossOver ? crossingOffset : -crossingOffset), shortLabel, style=labelStyle, color=d2Pattern == "Higher Low" ? labelColorHL : labelColorLH, textcolor=color.black, size=size.small)
h0 = hline(80, "Upper Band", color=#787B86)
hline(50, "Middle Band", color=color.new(#e5ff00, 0))
hline(60, "Middle top Band", color=color.new(#e5ff00, 0), linestyle=hline.style_solid)
hline(40, "Middle base Band", color=color.new(#e5ff00, 0), linestyle=hline.style_solid)
hline(90, "Top top Band", color=color.new(#ffffff, 0))
hline(10, "Base Band", color=color.new(#ffffff, 0))
h1 = hline(20, "Lower Band", color=#787B86)
fill(h0, h1, color=color.rgb(33, 150, 243, 90), title="Background")

// ===== WEBHOOK ALERT (only when LH or HL happens) =====
if barstate.isconfirmed and (kCrossOver or kCrossUnder) and d2Pattern != ""
    alertStr = "{"
    alertStr += "\"symbol\":\"" + syminfo.ticker + "\","
    alertStr += "\"timeframe\":\"" + timeframe.period + "\","
    alertStr += "\"time\":\"" + str.tostring(time) + "\","
    alertStr += "\"price\":\"" + str.tostring(close) + "\","
    alertStr += "\"k\":\"" + str.tostring(k) + "\","
    alertStr += "\"d\":\"" + str.tostring(d) + "\","
    alertStr += "\"kDirection\":\"" + kDirection + "\","
    alertStr += "\"dDirection\":\"" + dDirection + "\","
    alertStr += "\"kCross\":\"" + kCross + "\","
    alertStr += "\"d2Signal\":\"Solo\","
    alertStr += "\"d2Pattern\":\"" + d2Pattern + "\","
    alertStr += "\"d2PatternValue\":\"" + str.tostring(d2PatternValue) + "\""
    alertStr += "}"
    alert(alertStr, alert.freq_once_per_bar_close)