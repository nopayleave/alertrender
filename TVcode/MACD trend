//@version=6
indicator(title="MACD Trend", shorttitle="MACD Trend", overlay=false, explicit_plot_zorder=true)

// ===== MACD Settings =====
string GRP1 = "MACD Settings"
int fast_length = input.int(10, title="Fast Length", group=GRP1, minval=1)
int slow_length = input.int(75, title="Slow Length", group=GRP1, minval=1)
int signal_length = input.int(20, title="Signal Smoothing", group=GRP1, minval=1, maxval=100)
src = input.source(close, title="Source", group=GRP1)
string sma_source = input.string("EMA", title="Oscillator MA Type", group=GRP1, options=["SMA", "EMA"])
string sma_signal = input.string("EMA", title="Signal Line MA Type", group=GRP1, options=["SMA", "EMA"])

// ===== Color Settings =====
string GRP2 = "MACD Line Colors"
color macdUpHistUpColor = input.color(color.new(#00ff00, 0), "MACD Up + Hist Up (Green)", group=GRP2)
color macdUpHistUpAboveSignalColor = input.color(color.new(#00ff00, 0), "MACD Up + Hist Up + Above Signal (Green #2)", group=GRP2, tooltip="When MACD is up, histogram is up, and MACD is above signal line")
color macdUpHistDownColor = input.color(color.new(#ffffff, 0), "MACD Up + Hist Down (White)", group=GRP2)
color macdDownHistUpColor = input.color(color.new(#ffffff, 0), "MACD Down + Hist Up (White)", group=GRP2, tooltip="When MACD is down but histogram is up")
color macdDownHistDownColor = input.color(color.new(#0088ff, 0), "MACD Down + Hist Down (Blue)", group=GRP2, tooltip="When MACD is down and histogram is down")
color macdDownHistDownBelowSignalColor = input.color(color.new(#0088ff, 0), "MACD Down + Hist Down + Below Signal (Blue #2)", group=GRP2, tooltip="When MACD is down, histogram is down, and MACD is below signal line")

string GRP3 = "Signal Line & Histogram"
color signalUpHistUpColor = input.color(color.new(#00ff00, 0), "Signal Up + Hist Up (Green)", group=GRP3)
color signalDownHistDownColor = input.color(color.new(#0088ff, 0), "Signal Down + Hist Down (Blue)", group=GRP3)
color signalElseColor = input.color(color.new(#ffffff, 0), "Signal Else (White)", group=GRP3, tooltip="When signal and histogram directions don't match")
color histUpColor = input.color(color.new(#00ff00, 0), "Histogram Up Color (Green)", group=GRP3)
color histDownColor = input.color(color.new(#0088ff, 0), "Histogram Down Color (Blue)", group=GRP3)
int macdLineWidth = input.int(2, title="MACD Line Width", group=GRP3, minval=1, maxval=5)
int signalLineWidth = input.int(1, title="Signal Line Width", group=GRP3, minval=1, maxval=5)

// ===== Background Colors =====
string GRP4 = "Background Colors"
bool showBackground = input.bool(true, title="Show Background Colors", group=GRP4)
color bgAboveZeroColor = input.color(color.new(#00ff00, 90), title="Background Above 0 (Green)", group=GRP4)
color bgBelowZeroColor = input.color(color.new(#0088ff, 90), title="Background Below 0 (Blue)", group=GRP4)
bool showMacdSignalBg = input.bool(true, title="Show MACD/Signal Background", group=GRP4, tooltip="Green when MACD above signal, red when signal above MACD")
color macdAboveSignalBgColor = input.color(color.new(#00ff00, 90), title="MACD Above Signal (Green)", group=GRP4)
color signalAboveMacdBgColor = input.color(color.new(#ff0000, 90), title="Signal Above MACD (Red)", group=GRP4)

// ===== Premarket MACD Range Background =====
string GRP5 = "Premarket MACD Range"
bool showPremarketRange = input.bool(true, title="Show Premarket Range", group=GRP5)
color premarketRangeColor = input.color(color.new(#787b86, 90), title="Premarket Range Color", group=GRP5)
bool showSignalRangeBg = input.bool(true, title="Show MACD Line Range Background", group=GRP5, tooltip="Red when MACD below range, green when above range, no bg when within range")
color signalRangeBgBelowColor = input.color(color.new(#ff0000, 90), title="MACD Below Range (Red)", group=GRP5)
color signalRangeBgAboveColor = input.color(color.new(#00ff00, 90), title="MACD Above Range (Green)", group=GRP5)
int premarketStartHour = input.int(4, title="Premarket Start Hour", group=GRP5, minval=0, maxval=23, tooltip="Hour when premarket starts (0-23, e.g., 4 for 4:00 AM)")
int premarketStartMinute = input.int(0, title="Premarket Start Minute", group=GRP5, minval=0, maxval=59)
int premarketEndHour = input.int(9, title="Premarket End Hour", group=GRP5, minval=0, maxval=23, tooltip="Hour when premarket ends (0-23, e.g., 9 for 9:00 AM)")
int premarketEndMinute = input.int(30, title="Premarket End Minute", group=GRP5, minval=0, maxval=59)

// ===== Calculations =====
fast_ma = sma_source == "SMA" ? ta.sma(src, fast_length) : ta.ema(src, fast_length)
slow_ma = sma_source == "SMA" ? ta.sma(src, slow_length) : ta.ema(src, slow_length)
macd = fast_ma - slow_ma
signal = sma_signal == "SMA" ? ta.sma(macd, signal_length) : ta.ema(macd, signal_length)
hist = macd - signal

// ===== Conditions =====
// MACD position relative to signal line
macdAboveSignal = macd >= signal
macdBelowSignal = macd < signal

// MACD direction
macdUp = macd >= macd[1]
macdDown = macd < macd[1]

// Histogram direction
histUp = hist >= hist[1]
histDown = hist < hist[1]

// Signal direction
signalUp = signal >= signal[1]
signalDown = signal < signal[1]

// ===== MACD Line Color Logic =====
// When MACD is up and histogram is up: green (green #2 if above signal line)
// When MACD is up and histogram is down: white
// When MACD is down and histogram is up: white
// When MACD is down and histogram is down: red (red #2 if below signal line)
color macdLineColor = na
if macdUp and histUp
    macdLineColor := macdAboveSignal ? macdUpHistUpAboveSignalColor : macdUpHistUpColor
else if macdUp and histDown
    macdLineColor := macdUpHistDownColor
else if macdDown and histUp
    macdLineColor := macdDownHistUpColor
else
    macdLineColor := macdBelowSignal ? macdDownHistDownBelowSignalColor : macdDownHistDownColor

// ===== Histogram Color =====
histColor = histUp ? histUpColor : histDownColor

// ===== Signal Line Color Logic =====
// Signal up + histogram up = green
// Signal down + histogram down = red
// Else = orange
color signalLineColor = na
if signalUp and histUp
    signalLineColor := signalUpHistUpColor
else if signalDown and histDown
    signalLineColor := signalDownHistDownColor
else
    signalLineColor := signalElseColor

// ===== Premarket MACD Range Calculation =====
// Check if we're in premarket session based on time
currentHour = hour(time)
currentMinute = minute(time)
currentTime = currentHour * 100 + currentMinute
premarketStartTime = premarketStartHour * 100 + premarketStartMinute
premarketEndTime = premarketEndHour * 100 + premarketEndMinute

// Check if current time is within premarket session
inPremarket = currentTime >= premarketStartTime and currentTime < premarketEndTime

// Track premarket high/low MACD values
var float premarketMacdHigh = na
var float premarketMacdLow = na

// Reset at start of new day (when we exit premarket and enter regular session)
isNewDay = ta.change(dayofweek) != 0 or ta.change(dayofmonth) != 0
wasInPremarket = inPremarket[1]
exitedPremarket = wasInPremarket and not inPremarket

if isNewDay or exitedPremarket
    // Keep the values from previous premarket session for display during regular hours
    // Only reset if it's a new day
    if isNewDay
        premarketMacdHigh := na
        premarketMacdLow := na

// Update premarket high/low during premarket session
if inPremarket
    if na(premarketMacdHigh) or macd > premarketMacdHigh
        premarketMacdHigh := macd
    if na(premarketMacdLow) or macd < premarketMacdLow
        premarketMacdLow := macd

// Use the tracked values for the background range
premarketRangeUpper = math.max(premarketMacdHigh, premarketMacdLow)
premarketRangeLower = math.min(premarketMacdHigh, premarketMacdLow)

// Determine MACD line position relative to premarket range
bool macdBelowRange = not na(premarketRangeLower) and macd < premarketRangeLower
bool macdAboveRange = not na(premarketRangeUpper) and macd > premarketRangeUpper
bool macdWithinRange = not na(premarketRangeLower) and not na(premarketRangeUpper) and macd >= premarketRangeLower and macd <= premarketRangeUpper

// ===== Display =====
// Zero line
hline(0, "Zero Line", color=color.new(#787b86, 50))

// Background colors based on MACD position relative to 0
// Use bgcolor for continuous background fill
bgcolor(showBackground and macd >= 0 ? bgAboveZeroColor : showBackground and macd < 0 ? bgBelowZeroColor : na)

// Background color based on MACD line position relative to premarket range
bgcolor(showSignalRangeBg and macdBelowRange ? signalRangeBgBelowColor : showSignalRangeBg and macdAboveRange ? signalRangeBgAboveColor : na)

// Background color based on MACD/Signal relationship
bgcolor(showMacdSignalBg and macdAboveSignal ? macdAboveSignalBgColor : showMacdSignalBg and macdBelowSignal ? signalAboveMacdBgColor : na)

// Premarket MACD range background
p_premarketUpper = plot(not na(premarketRangeUpper) and showPremarketRange ? premarketRangeUpper : na, "Premarket High", color=color.new(color.white, 100), display=display.none)
p_premarketLower = plot(not na(premarketRangeLower) and showPremarketRange ? premarketRangeLower : na, "Premarket Low", color=color.new(color.white, 100), display=display.none)
fill(p_premarketUpper, p_premarketLower, color=showPremarketRange and not na(premarketRangeUpper) and not na(premarketRangeLower) ? premarketRangeColor : na, title="Premarket MACD Range")

// Plot histogram
plot(hist, title="Histogram", style=plot.style_columns, color=histColor)

// Plot MACD line with conditional coloring
plot(macd, title="MACD", color=macdLineColor, linewidth=macdLineWidth)

// Plot signal line with conditional coloring
plot(signal, title="Signal", color=signalLineColor, linewidth=signalLineWidth)

// ===== Alerts =====
alertcondition(hist[1] >= 0 and hist < 0, title='Rising to falling', message='The MACD histogram switched from a rising to falling state')
alertcondition(hist[1] <= 0 and hist > 0, title='Falling to rising', message='The MACD histogram switched from a falling to rising state')
alertcondition(ta.crossover(macd, signal), title='MACD Crossover', message='MACD crossed above Signal')
alertcondition(ta.crossunder(macd, signal), title='MACD Crossunder', message='MACD crossed below Signal')
